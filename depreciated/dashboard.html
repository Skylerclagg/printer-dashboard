<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ dashboard_title }}</title>
    <style>
        body { background: #f0f2f5; color: #333; padding: 1rem; margin: 0; }
        h1 { text-align: center; color: #444; }
        #dash { display: grid; gap: 1.5rem; max-width: 1600px; margin: auto; }
        /* NEW: Make cards part of a link */
        .card-link { text-decoration: none; color: inherit; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .card-img { width: 100%; height: 180px; object-fit: contain; background-color: #e9ecef; }
        .card-content { padding: 1rem 1.5rem; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .card h4 { margin: 0 0 0.5rem 0; font-size: 1.25em; color: #0056b3; }
        .filename { font-size: 0.8em; color: #6c757d; margin-bottom: 0.5rem; word-break: break-all; }
        .status { display: inline-block; padding: .3rem .8rem; margin: .5rem 0; border-radius: 99px; color: #fff; font-size: .8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .override .status { border: 2px dashed #ffc107; box-shadow: 0 0 0 2px #6c757d; }
        .progress-bar { background: #e9ecef; border-radius: 99px; overflow: hidden; position: relative; }
        .progress-bar .progress-fill { height: 100%; transition: width 0.5s ease-in-out; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; text-align: left; margin-top: 1rem; }
        .stats-grid span { font-size: 0.9em; }
        .temps { display: flex; justify-content: space-around; font-size: 0.9em; margin-top: 1rem; border-top: 1px solid #e9ecef; padding-top: 1rem; flex-wrap: wrap; gap: 8px; }
        .error-message { font-size: 0.8em; color: #dc3545; margin-top: 0.5rem; }
        .flash { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border: 1px solid transparent; max-width: 1200px; margin: 1rem auto; }
        .flash-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    </style>
</head>
<body>
    <h1>{{ dashboard_title }}</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div id="dash"><p>Loading printer statuses...</p></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let refreshTimeout;

        function applyStyles(config) {
            const cardSize = config.card_size || 'medium';
            const fontFamily = config.font_family || 'sans-serif';

            let gridCols = 'minmax(300px, 1fr)';
            if (cardSize === 'small') gridCols = 'minmax(250px, 1fr)';
            if (cardSize === 'large') gridCols = 'minmax(400px, 1fr)';
            document.getElementById('dash').style.gridTemplateColumns = `repeat(auto-fill, ${gridCols})`;
            document.body.style.fontFamily = fontFamily;
        }

        function formatTime(s){if(s===null||s<=0)return'—';const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h>0?`${h}h ${m}m`:`${m}m`;}
        
        function render(data){
            const t=$('#dash');
            const config=data.config||{status_colors:{}};
            applyStyles(config);
            const printerData = { ...data };
            delete printerData.config;
            delete printerData.kiosk_config;

            let printerArray = Object.entries(printerData);

            if (config.sort_by === 'status') {
                const statusOrder = config.status_order || [];
                const statusMap = new Map(statusOrder.map((status, index) => [status, index]));
                printerArray.sort(([, a], [, b]) => (statusMap.get(a.state) ?? 999) - (statusMap.get(b.state) ?? 999));
            } else if (config.sort_by === 'manual' || !config.sort_by) {
                const printerOrder = config.printer_order || [];
                const printerMap = new Map(printerOrder.map((name, index) => [name, index]));
                printerArray.sort(([aName], [bName]) => (printerMap.get(aName) ?? 999) - (printerMap.get(bName) ?? 999));
            }

            t.empty();
            if(printerArray.length===0){t.html('<p>No printers found. Please add one in the /admin panel.</p>');return}
            
            printerArray.forEach(([e,n])=>{
                let a=n.state||'unknown';
                let error_msg = n.error || null;
                if (a === 'Config Error') { a = 'Offline'; }

                const o=a.toLowerCase().replace(/\s+/g,'-'),s=n.progress!=null?n.progress:0,i=formatTime(n.time_remaining),l=formatTime(n.time_elapsed),r=n.override?'card override':'card';let m='—';if(n.nozzle_temp!==null){if(Array.isArray(n.nozzle_temp)){m=n.nozzle_temp.map((t,e)=>`T${e}:${t}°C`).join(' ')}else{m=n.nozzle_temp+'°C'}}const p=n.image_src||`https://via.placeholder.com/400x200/dee2e6/6c757d?text=${e}`;const u=config.status_colors[o]||'#6c757d';let timeHtml='';if(a==='Printing'){let pb_fs=(config.progress_bar_font_size_px||12)+'px';let pb_h=(config.progress_bar_height_px||14)+'px';let pb_shadow=config.progress_bar_text_shadow?'1px 1px 1px rgba(0,0,0,0.5), -1px -1px 0 rgba(0,0,0,0.5), 1px -1px 0 rgba(0,0,0,0.5), -1px 1px 0 rgba(0,0,0,0.5)':'none';timeHtml=`<div class="progress-bar" style="height:${pb_h};margin: 0.75rem 0;"><div class="progress-text" style="color:${config.progress_bar_text_color};font-size:${pb_fs};line-height:${pb_h};text-shadow:${pb_shadow};">${s}%</div><div class="progress-fill" style="width:${s}%;background-color:${config.progress_bar_color};"></div></div><div class="stats-grid" style="font-size:${config.font_size_details_px}px;"><span><strong>Elapsed:</strong> ${l}</span><span><strong>Remaining:</strong> ${i}</span></div>`}let tempsHtml='';const hideTempsFor=['Offline','Under Maintenance','Unsupported','Error','Config Error'];if(!hideTempsFor.includes(n.state)){tempsHtml=`<div class="temps" style="font-size:${config.font_size_details_px}px;"><span><img src="https://api.iconify.design/mdi/heat-bed.svg?color=%23888888" alt="Bed"> ${n.bed_temp!=null?n.bed_temp+'°C':'—'}</span><span><img src="https://api.iconify.design/mdi/nozzle.svg?color=%23888888" alt="Nozzle"> ${m}</span></div>`} let errorHtml = n.state === 'Config Error' ? `<div class="error-message">Error: ${error_msg}</div>` : ''; 
                
                const cardContent = `<div class="${r}"><img src="${p}" class="card-img" alt="${e}" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x200/dee2e6/6c757d?text=Image+Error';"><div class="card-content"><h4 style="font-size:${config.font_size_printer_name_px}px;">${e}</h4><span class="status" style="background-color:${u}; font-size:${config.font_size_status_px}px;">${a}</span>${errorHtml}${timeHtml}${tempsHtml}</div></div>`;
                
                // NEW: If user can upload, wrap the card in a link
                const userCanUpload = {{ user_can_upload|tojson }};
                if (userCanUpload) {
                    t.append(`<a href="/upload/${e}" class="card-link">${cardContent}</a>`);
                } else {
                    t.append(cardContent);
                }
            });
        }
        
        function fetchAndRender() {
            $.getJSON('/status_json')
                .done(data => {
                    const refreshInterval = (data.config.refresh_interval_sec || 30) * 1000;
                    render(data);
                    clearTimeout(refreshTimeout);
                    refreshTimeout = setTimeout(fetchAndRender, refreshInterval);
                })
                .fail(() => {
                    clearTimeout(refreshTimeout);
                    refreshTimeout = setTimeout(fetchAndRender, 30000); // Retry after 30s on failure
                });
        }

        $(document).ready(function(){
            fetchAndRender(); // Initial call
        });
    </script>
</body>
</html>
