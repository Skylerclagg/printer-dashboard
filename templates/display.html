<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kiosk Display</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; cursor: none; }
        #kiosk-container { width: 100%; height: 100%; position: relative; }
        .slide { width: 100%; height: 100%; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 1s ease-in-out; background-size: contain; background-position: center; background-repeat: no-repeat; }
        .slide.active { opacity: 1; z-index: 1; }
    </style>
</head>
<body>
    <div id="kiosk-container"><h1 style="text-align:center; padding-top: 2rem; color: white;">Loading Display...</h1></div>
    
    <!-- Embed initial data in a safe script tag -->
    <script id="kiosk-data" type="application/json">
        {{ kiosk_config|tojson|safe }}
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const kioskContainer = document.getElementById('kiosk-container');
        const kioskId = "{{ kiosk_id }}";
        let initialKioskConfig = JSON.parse(document.getElementById('kiosk-data').textContent);
        let slides = [];
        let currentSlideIndex = 0;
        
        // Timer state variables
        let slideTimeout;
        let slideStartTime;
        let slideDuration;

        function buildAndRenderSlides(kioskConfig) {
            // Calculate time remaining on the current slide before rebuilding
            let timeRemaining = null;
            if (slideStartTime && slideDuration) {
                const elapsedTime = Date.now() - slideStartTime;
                timeRemaining = slideDuration - elapsedTime;
                if (timeRemaining < 0) {
                    timeRemaining = 0; // If timer expired, change immediately
                }
            }

            document.body.style.backgroundColor = kioskConfig.kiosk_background_color || '#000';
            
            slides = kioskConfig.kiosk_images || [];
            
            kioskContainer.innerHTML = '';
            if (slides.length === 0) {
                kioskContainer.innerHTML = '<h1 style="text-align:center; color: white; padding-top: 2rem;">Please add an active image in the admin panel.</h1>';
                clearTimeout(slideTimeout);
                return;
            }

            slides.forEach((slideData, index) => {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide';
                slideDiv.id = 'slide-' + index;
                slideDiv.style.backgroundImage = `url(${slideData.url})`;
                kioskContainer.appendChild(slideDiv);
            });

            if (currentSlideIndex >= slides.length) {
                currentSlideIndex = 0;
            }

            showCurrentSlide();
            // Restart the timer with the remaining time
            cycleSlide(kioskConfig, timeRemaining);
        }

        function showCurrentSlide() {
            if (slides.length === 0) return;
            if (currentSlideIndex >= slides.length) {
                currentSlideIndex = 0;
            }
            $('.slide').removeClass('active');
            $('#slide-' + currentSlideIndex).addClass('active');
        }

        function cycleSlide(kioskConfig, initialDelay = null) {
            clearTimeout(slideTimeout);
            if (slides.length <= 1) {
                return;
            }

            const current = slides[currentSlideIndex];
            slideDuration = (current.time || kioskConfig.kiosk_image_page_time || 5) * 1000;
            
            // Use the initialDelay if provided (from a refresh), otherwise use the full duration
            const delay = initialDelay !== null ? initialDelay : slideDuration;

            slideStartTime = Date.now();
            slideTimeout = setTimeout(() => {
                currentSlideIndex = (currentSlideIndex + 1) % slides.length;
                showCurrentSlide();
                // Subsequent calls will use the full duration
                cycleSlide(kioskConfig);
            }, delay);
        }

        function fetchData() {
            $.getJSON(`/status_json?kiosk=${kioskId}`)
                .done(data => {
                    if (data.kiosk_config) {
                        data.kiosk_config.kiosk_images = (data.kiosk_config.kiosk_images || []).filter(img => img.active !== false);
                        buildAndRenderSlides(data.kiosk_config);
                    }
                })
                .fail(() => {
                    console.error("Failed to fetch kiosk data update.");
                });
        }

        $(document).ready(function() {
            // Initial render with data from the server
            buildAndRenderSlides(initialKioskConfig);

            // Set up a timer to periodically fetch new data
            const refreshInterval = (initialKioskConfig.refresh_interval_sec || 30) * 1000;
            setInterval(fetchData, refreshInterval);
        });
    </script>
</body>
</html>
